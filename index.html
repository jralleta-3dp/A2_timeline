<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2 Timeline</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(120deg, #f7f7f7 0%, #e3e3e3 100%);
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
        }
        .header-label {
            color: #111;
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 60px auto 30px 7vw;
            text-align: left;
            background: none;
            box-shadow: none;
            border-radius: 0;
            padding: 0;
        }
        .header-label .timeline-highlight {
            color: #222;
            background: linear-gradient(90deg, #f7f7f7 60%, #e3e3e3 100%);
            border-radius: 12px;
            padding: 0.2em 0.8em 0.2em 0.8em;
            margin-left: 0.3em;
            box-shadow: 0 2px 24px 0 rgba(60,60,60,0.08);
            font-weight: 600;
            display: inline-block;
            border: 1px solid #e0e0e0;
            backdrop-filter: blur(2px);
            text-shadow: 0 1.5px 0 #fff, 0 2px 8px rgba(80,80,80,0.10);
            transition: box-shadow 0.2s, background 0.2s;
        }
        .header-label .timeline-highlight:hover {
            box-shadow: 0 6px 18px 0 rgba(80,80,80,0.13), 0 1.5px 0 #fff inset;
            background: linear-gradient(90deg, #ededed 60%, #cccccc 100%);
        }
        .main-container {
            background: #fff;
            width: 80vw;
            max-width: 1440px;
            min-height: 540px;
            aspect-ratio: 16 / 9;
            margin: 40px auto 0 auto;
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(80,90,120,0.10), 0 1.5px 0 #fff inset;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 32px;
            border: 1px solid #e0e0e0;
            padding: 48px;
            z-index: 1;        }        .main-container.single-section {
            background: #fff;
            width: 80vw;
            max-width: 1440px;
            height: auto; /* Will be set explicitly by JavaScript */
            min-height: 100px; /* Ensure a reasonable starting height */
            margin: 20px auto 0 auto;
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(80,90,120,0.10), 0 1.5px 0 #fff inset;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            border: 1px solid #e0e0e0;
            padding: 24px 48px 20px 48px; /* Added bottom padding */
            z-index: 1;
            position: relative;
            overflow: visible; /* Ensure content like tooltips can overflow */
        }
        .timeline-section {
            background: #f7f8fa;
            border-radius: 12px;
            box-shadow: 0 2px 12px 0 rgba(80,90,120,0.06);
            padding: 32px 24px 24px 24px;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #444c5e;
            margin-bottom: 16px; /* Reduced margin */
            letter-spacing: 1px;
        }          .countdown-container {
            position: absolute;
            top: 24px;
            right: 48px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            max-width: 300px;
            text-align: right;
        }          .countdown-label {
            color: #e74c3c;
            font-weight: 600;
            margin-right: 10px;
            max-width: 250px; /* Increased from 200px to allow for longer event names */
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95rem;
            margin-bottom: 4px; /* Added margin to separate label from timer when wrapped */
            line-height: 1.3;
        }
        
        .countdown-label span {
            font-weight: 700;
        }
          .countdown-timer {
            color: #222;
            font-weight: 500;
            font-family: monospace;
            background: rgba(247, 247, 247, 0.7);
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: inline-block; /* Added to ensure proper rendering */
            min-width: 80px; /* Added to maintain consistent width */
            text-align: center; /* Center the time */
        }.event-blocks {
            position: relative;
            width: 100%;
            min-height: 50px;
            transition: height 0.3s ease;
        }.event-block {
            background: #f8fffa;
            border-radius: 8px;
            box-shadow: 0 1.5px 8px 0 rgba(80,90,120,0.08);
            padding: 8px 0;
            font-size: 0.9rem;
            color: #23272f;
            font-weight: 500;
            min-width: 40px;
            text-align: center;
            transition: all 0.2s ease;
            overflow: hidden;
            white-space: nowrap;
            border-left: 4px solid #2ecc40;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }.event-block:hover {
            background: #edfff2;
            box-shadow: 0 4px 18px 0 rgba(80,90,120,0.13);
            transform: translateY(-2px);
        }
        
        /* Event popup styles */
        .event-popup {
            position: absolute;
            background: white;
            border-radius: 6px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
            padding: 10px 14px;
            z-index: 50;
            font-size: 0.9rem;
            max-width: 250px;
            pointer-events: none;
            animation: fadeIn 0.2s ease-out;
            border: 1px solid #e0e0e0;
        }
        
        .event-popup-name {
            font-weight: 600;
            color: #2ecc40;
            margin-bottom: 5px;
        }
        
        .event-popup-time {
            color: #444c5e;
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        
        .event-list-item {
            transition: all 0.2s ease;
            border-left: 3px solid #2ecc40;
        }
        .event-list-item:hover {
            transform: translateX(3px);
            background: #edfff2 !important;
        }
        .timeline-bar {
            position: relative;
            width: 100%;
            height: 54px;
            margin-bottom: 32px;
        }
        .timeline-bar.timeline-hashmarks {
            width: 80vw;
            max-width: 1440px;
            margin: 0 auto 0 auto;
            height: 54px;
            position: relative;
            background: none;
            box-shadow: none;
            z-index: 2;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .timeline-hashmarks-outer {
            position: relative;
            width: 100%;
            margin: 0 auto;
            height: 48px;
            display: flex;
            align-items: flex-start;
            pointer-events: none;
        }
        .timeline-hashmarks-track {
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #bfc4cc 0%, #7e8696 100%);
            border-radius: 2px;
            position: absolute;
            top: 20px;
            left: 0;
            z-index: 1;
        }
        .timeline-ticks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 48px;
            pointer-events: none;
            z-index: 2;
        }
        .timeline-hashmark {
            position: absolute;
            top: 10px;
            width: 2px;
            height: 16px;
            background: #444c5e;
            border-radius: 2px;
        }
        .timeline-hashmark.major {
            height: 24px;
            width: 3.5px;
            background: #23272f;
        }
        .timeline-label {
            position: absolute;
            top: 32px;
            transform: translateX(-50%);
            font-size: 0.85rem;
            color: #444c5e;
            font-weight: 500;
            user-select: none;
            text-align: center;
            white-space: pre-line;
            line-height: 1.2;        }        #timeline-cursor {
            position: absolute;
            top: 10px;
            width: 2px;
            height: 100px; /* Initial height, will be set dynamically */
            background: linear-gradient(180deg, 
                rgba(46,204,64,0.7) 0%, 
                rgba(46,204,64,0.7) 5%, 
                rgba(46,204,64,0.6) 10%, 
                rgba(46,204,64,0.3) 40%, 
                rgba(46,204,64,0.1) 100%);
            border-radius: 2px 2px 0 0;
            box-shadow: none;
            z-index: 20; /* Increased z-index to be above events */
            pointer-events: none;
            transition: left 0.2s linear, height 0.3s ease;
            display: block;
            opacity: 0.8;
        }/* Timeline cursor with extended state */        #timeline-cursor.active {
            background: linear-gradient(180deg, 
                rgba(46,204,64,0.8) 0%, 
                rgba(46,204,64,0.7) 5%, 
                rgba(46,204,64,0.6) 10%, 
                rgba(46,204,64,0.4) 30%,
                rgba(46,204,64,0.2) 70%, 
                rgba(46,204,64,0.1) 100%);
            box-shadow: none;
            opacity: 0.9;
        }
        @media (max-width: 1200px) {
            .main-container { width: 97vw; max-width: 100vw; padding: 24px; }
        }
        .logistics-menu {
            position: fixed;
            top: 24px;
            right: 36px;
            z-index: 100;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: flex-end;
            width: auto;
            margin: 0;
        }
        .hamburger {
            width: 40px;
            height: 40px;
            background: #fff;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-right: 8px;
            transition: box-shadow 0.2s;
        }
        .hamburger span {
            display: block;
            width: 24px;
            height: 3px;
            background: #444c5e;
            margin: 3px 0;
            border-radius: 2px;
            transition: background 0.2s;
        }        .timeline-controls {
            position: absolute;
            right: 0;
            top: 48px;
            background: #fff;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 18px 0 rgba(80,90,120,0.13);
            padding: 16px 24px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 240px;
        }
        .control-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 12px;
        }
        .control-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .control-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #444c5e;
            margin-bottom: 6px;
        }
        .timeline-controls button {
            background: #2ecc40;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            opacity: 0.85;
            transition: background 0.2s, opacity 0.2s;
            text-align: left;
        }
        .timeline-controls button.secondary {
            background: #f7f8fa;
            color: #444c5e;
            border: 1px solid #e0e0e0;
        }
        .timeline-controls button.secondary:hover {
            background: #e9ecf2;
        }
        .timeline-controls button:hover {
            background: #27ae60;
            opacity: 1;
        }
        .timeline-controls input, .timeline-controls select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            font-size: 0.9rem;
            color: #444c5e;
        }
        .form-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        .form-row label {
            font-size: 0.85rem;
            color: #444c5e;
            min-width: 60px;
        }        .timezone-indicator {
            position: absolute;
            bottom: 80px;
            right: 0;
            font-size: 0.8rem;
            color: #666;
            background: rgba(255,255,255,0.8);
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 400;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: opacity 0.3s ease;
        }
        .timezone-indicator:hover {
            opacity: 0.8;
        }/* GMT time display styles */
        .current-time-display {
            position: absolute;
            top: -60px;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            z-index: 5;
            transition: all 0.3s ease;
        }
        .time-label {
            margin: 3px 0;
            font-weight: 500;
            color: #444c5e;
        }
        .mode-indicator {
            font-size: 0.85rem;
            color: #2ecc40;
            font-weight: 500;
            margin: 0 0 8px 0;
            padding: 4px 0;
        }        /* Time panel for organizing time information */
        .time-panel {
            position: absolute;
            top: -40px;
            left: 10px;
            display: flex;
            flex-direction: row;
            gap: 10px;
            z-index: 5;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
            padding: 4px 8px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .time-panel-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            font-size: 0.85rem;
            color: #444c5e;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .time-panel-label {
            font-weight: 600;
            color: #23272f;
        }
        /* Animations and transitions */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .timeline-controls {
            animation: fadeIn 0.2s ease-out;
        }
        
        .control-section {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Overlay for better modal experience */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.2);
            z-index: 15;
            display: none;
            backdrop-filter: blur(2px);
        }

        .page-header {
            text-align: center;
            margin-top: 20px;
            font-size: 2.5rem;
            color: #444c5e;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <br>
    <br>
    <div class="page-header">
        <span class="timeline-highlight">A2 Timeline Prototype</span>
    </div>
    <br>
    <br>
    <div class="header-label"></div>
    <div class="timeline-bar timeline-hashmarks">
        <div class="timeline-hashmarks-outer">
            <div class="timeline-hashmarks-track" id="timeline-hashmarks-track"></div>
            <div id="timeline-cursor"></div>
            <div class="timeline-ticks" id="timeline-ticks"></div>
        </div>    </div>    <div class="main-container single-section" id="section1-container">
        <div class="section-title">Mission</div>        <div class="countdown-container">
            <div class="countdown-label">Next Event:</div>
            <div class="countdown-timer" id="next-event-countdown">--:--:--</div>
        </div>
    </div>
      <div class="main-container single-section" id="section2-container" style="margin-top: 30px;">
        <div class="section-title">SER</div>        <div class="countdown-container">
            <div class="countdown-label">Next Event:</div>
            <div class="countdown-timer" id="section2-next-event-countdown">--:--:--</div>
        </div>
    </div>
    
    <div class="main-container single-section" id="section3-container" style="margin-top: 30px;">
        <div class="section-title">SMOR</div>        <div class="countdown-container">
            <div class="countdown-label">Next Event:</div>
            <div class="countdown-timer" id="section3-next-event-countdown">--:--:--</div>
        </div>
    </div>    
    <!-- Event popup that will be positioned dynamically -->
    <div id="event-popup" class="event-popup" style="display: none;"></div>
    
    <div class="modal-backdrop" id="menuBackdrop"></div>
    <div class="logistics-menu">
        <button class="hamburger" id="logisticsMenuBtn" aria-label="Open logistics menu">
            <span></span><span></span><span></span>
        </button>
        <div class="timeline-controls" id="timelineControls" style="display:none;"><div class="control-section">
                <div class="control-section-title">Timeline Controls</div>
                <div id="modeIndicator" class="mode-indicator">Real-Time Mode (GMT)</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button id="startTimeline">Real-Time (GMT)</button>
                    <button id="startAnimation">Animation</button>
                    <button id="stopTimeline">Pause</button>
                    <button id="resetTimeline">Reset</button>
                </div>
            </div>
            <div class="control-section">
                <div class="control-section-title">Event Management</div>
                <button id="createEventBtn">Create New Event</button>
                <button id="manageEventsBtn" class="secondary">Edit/Delete Events</button>
            </div>
            <div class="control-section" id="eventFormSection" style="display: none;">
                <div class="control-section-title">Create Event</div>
                <div class="form-row">
                    <label for="eventName">Name</label>
                    <input type="text" id="eventName" placeholder="Event name">
                </div>                <div class="form-row">
                    <label for="eventStartHour">Start</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="number" id="eventStartHour" min="0" max="23" step="1" placeholder="Hour" style="width: 60px;">
                        <span>:</span>
                        <input type="number" id="eventStartMinute" min="0" max="59" step="1" placeholder="Min" style="width: 60px;">
                        <span style="margin-left: 4px; font-size: 0.8rem; color: #666;">GMT</span>
                    </div>
                </div>
                <div class="form-row">
                    <label for="eventEndHour">End</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="number" id="eventEndHour" min="0" max="23" step="1" placeholder="Hour" style="width: 60px;">
                        <span>:</span>
                        <input type="number" id="eventEndMinute" min="0" max="59" step="1" placeholder="Min" style="width: 60px;">
                        <span style="margin-left: 4px; font-size: 0.8rem; color: #666;">GMT</span>
                    </div>
                </div>                <div class="form-row">
                    <label for="eventSection">Section</label>
                    <select id="eventSection">
                        <option value="section1">Section 1</option>
                        <option value="section2">Section 2</option>
                        <option value="section3">Section 3</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="eventColor">Color</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="color" id="eventColor" value="#2ecc40" style="width: 40px; height: 30px; padding: 0; border: none;">
                        <div class="color-preset" style="display: flex; gap: 4px;">
                            <div class="color-box" data-color="#2ecc40" style="background: #2ecc40; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                            <div class="color-box" data-color="#e74c3c" style="background: #e74c3c; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                            <div class="color-box" data-color="#3498db" style="background: #3498db; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                            <div class="color-box" data-color="#f39c12" style="background: #f39c12; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                            <div class="color-box" data-color="#9b59b6" style="background: #9b59b6; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                        </div>
                    </div>
                </div>                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button id="saveEventBtn">Save Event</button>
                    <button id="cancelEventBtn" class="secondary">Cancel</button>
                </div>
            </div>
            <div class="control-section" id="eventListSection" style="display: none;">
                <div class="control-section-title">Edit Events</div>
                <div id="eventsList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Event list will be populated here -->
                </div>
                <button id="backToEventsBtn" class="secondary" style="margin-top: 8px;">Back</button>
            </div>
            <div class="control-section" id="editEventSection" style="display: none;">
                <div class="control-section-title">Edit Event</div>
                <input type="hidden" id="editEventId">
                <div class="form-row">
                    <label for="editEventName">Name</label>
                    <input type="text" id="editEventName" placeholder="Event name">
                </div>                <div class="form-row">
                    <label for="editEventStartHour">Start</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="number" id="editEventStartHour" min="0" max="23" step="1" placeholder="Hour" style="width: 60px;">
                        <span>:</span>
                        <input type="number" id="editEventStartMinute" min="0" max="59" step="1" placeholder="Min" style="width: 60px;">
                        <span style="margin-left: 4px; font-size: 0.8rem; color: #666;">GMT</span>
                    </div>
                </div>                <div class="form-row">
                    <label for="editEventEndHour">End</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="number" id="editEventEndHour" min="0" max="23" step="1" placeholder="Hour" style="width: 60px;">
                        <span>:</span>
                        <input type="number" id="editEventEndMinute" min="0" max="59" step="1" placeholder="Min" style="width: 60px;">
                        <span style="margin-left: 4px; font-size: 0.8rem; color: #666;">GMT</span>
                    </div>
                </div>
                <div class="form-row">
                    <label for="editEventColor">Color</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="color" id="editEventColor" value="#2ecc40" style="width: 40px; height: 30px; padding: 0; border: none;">
                        <div class="color-preset" style="display: flex; gap: 4px;">
                            <div class="color-box" data-color="#2ecc40" style="background: #2ecc40; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                            <div class="color-box" data-color="#e74c3c" style="background: #e74c3c; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                            <div class="color-box" data-color="#3498db" style="background: #3498db; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                            <div class="color-box" data-color="#f39c12" style="background: #f39c12; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                            <div class="color-box" data-color="#9b59b6" style="background: #9b59b6; width: 20px; height: 20px; border-radius: 4px; cursor: pointer;"></div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <label for="editEventSection">Section</label>                    <select id="editEventSection">
                        <option value="section1">Section 1</option>
                        <option value="section2">Section 2</option>
                        <option value="section3">Section 3</option>
                    </select>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button id="updateEventBtn">Update</button>
                    <button id="deleteEventBtn" style="background: #e74c3c;">Delete</button>
                    <button id="cancelEditBtn" class="secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <script>    // Render static hashline with horizontal ticks and labels using GMT time
    function renderStaticHashmarks() {
        const track = document.getElementById('timeline-hashmarks-track');
        const ticks = document.getElementById('timeline-ticks');
        track.innerHTML = '';
        ticks.innerHTML = '';
        const range = 24;
        
        // Get current timezone offset in hours
        const date = new Date();
        const timeZoneOffset = date.getTimezoneOffset() / 60;
        const timeZoneName = Intl.DateTimeFormat().resolvedOptions().timeZone;
        
        for (let i = 0; i <= range; i++) {
            const percent = (i / range) * 100;
            // Tick
            const tick = document.createElement('div');
            tick.className = 'timeline-hashmark' + (i % 4 === 0 ? ' major' : '');
            tick.style.left = percent + '%';
            ticks.appendChild(tick);
            
            // Label with actual time (UTC/GMT)
            const label = document.createElement('div');
            label.className = 'timeline-label';
            label.style.left = percent + '%';
            
            // Format the time label
            let hour = i;
            const hourPadded = hour.toString().padStart(2, '0');
            let timeText = `${hourPadded}:00`;
            
            // Add GMT indicator for major ticks only to avoid clutter
            if (i % 4 === 0) {
                timeText = `${timeText}\nGMT`;
            }
            
            label.innerHTML = timeText;
            ticks.appendChild(label);
        }
          // Add timezone indicator
        const timezoneIndicator = document.createElement('div');
        timezoneIndicator.className = 'timezone-indicator';
        
        // Format the timezone name to be more readable
        const formattedTimeZone = timeZoneName.replace('/', ' - ').replace('_', ' ');
        timezoneIndicator.innerHTML = `<span style="font-weight: 600;">Local Timezone:</span> ${formattedTimeZone}`;
        
        // Append to the parent of ticks for better positioning
        const parent = document.querySelector('.timeline-bar.timeline-hashmarks');
        parent.appendChild(timezoneIndicator);
    }document.addEventListener('DOMContentLoaded', function() {
        renderStaticHashmarks();
        
        // Set up the cursor line after the page has fully loaded
        window.addEventListener('load', function() {
            setTimeout(function() {
                updateTimelineCursor(0);
            }, 200);
        });
    });
    
    // Handle window resize to adjust cursor height
    window.addEventListener('resize', function() {
        // Update cursor height on window resize
        const currentPosition = document.getElementById('timeline-cursor').style.left;
        updateTimelineCursor(parseFloat(currentPosition) || 0);
    });
      // Store events with unique IDs
    let allEvents = [];
    let currentEventId = 0;    // Function to create an event with minute precision
    function createEvent(name, startHour, startMinute, endHour, endMinute, section = "section1", color = "#2ecc40") {
        const id = currentEventId++;
        
        // Convert to decimal hours for positioning (e.g., 1:30 becomes 1.5)
        const start = startHour + (startMinute / 60);
        const end = endHour + (endMinute / 60);
        
        const event = { 
            id, 
            name, 
            startHour, 
            startMinute, 
            endHour, 
            endMinute, 
            start, // decimal hours for positioning
            end,   // decimal hours for positioning
            section,
            color  // Store the event color
        };
        
        allEvents.push(event);
        saveEvents();
        renderAndPlaceEvents();
        updateNextEventCountdown(); // Update countdown after creating an event
        return event;
    }    // Function to update an event with minute precision
    function updateEvent(id, newData) {
        const index = allEvents.findIndex(event => event.id === id);
        if (index !== -1) {
            // If hour/minute values are being updated, recalculate decimal values
            if (newData.startHour !== undefined || newData.startMinute !== undefined) {
                const startHour = newData.startHour !== undefined ? newData.startHour : allEvents[index].startHour;
                const startMinute = newData.startMinute !== undefined ? newData.startMinute : allEvents[index].startMinute;
                newData.start = startHour + (startMinute / 60);
            }
            
            if (newData.endHour !== undefined || newData.endMinute !== undefined) {
                const endHour = newData.endHour !== undefined ? newData.endHour : allEvents[index].endHour;
                const endMinute = newData.endMinute !== undefined ? newData.endMinute : allEvents[index].endMinute;
                newData.end = endHour + (endMinute / 60);
            }
            
            allEvents[index] = { ...allEvents[index], ...newData };
            saveEvents();
            renderAndPlaceEvents();
            updateNextEventCountdown(); // Update countdown after event update
            return true;
        }
        return false;
    }

    // Function to delete an event
    function deleteEvent(id) {
        const index = allEvents.findIndex(event => event.id === id);
        if (index !== -1) {
            allEvents.splice(index, 1);
            saveEvents();
            renderAndPlaceEvents();
            updateNextEventCountdown(); // Update countdown after event deletion
            return true;
        }
        return false;
    }// Function to save events to local storage
    function saveEvents() {
        localStorage.setItem('calendarEvents', JSON.stringify(allEvents));
        localStorage.setItem('currentEventId', currentEventId.toString());
    }

    // Function to load events from local storage
    function loadEvents() {
        const savedEvents = localStorage.getItem('calendarEvents');
        const savedEventId = localStorage.getItem('currentEventId');
        
        if (savedEvents) {
            allEvents = JSON.parse(savedEvents);
        }
        
        if (savedEventId) {
            currentEventId = parseInt(savedEventId, 10);
        }
          renderAndPlaceEvents();
        updateNextEventCountdown(); // Update countdown after loading events
    }
    
    // Function to render/place all events
    function renderAndPlaceEvents() {
        // Render events for all sections
        renderSectionEvents('section1');
        renderSectionEvents('section2');
        renderSectionEvents('section3');
        
        // Update the events list in the menu if it's open
        renderEventsList();
    }
    
    function renderSectionEvents(sectionId) {
        const section = document.getElementById(sectionId + '-container');
        if (!section) return;
        
        let blocksContainer = section.querySelector('.event-blocks');
        if (!blocksContainer) {
            blocksContainer = document.createElement('div');
            blocksContainer.className = 'event-blocks';
            blocksContainer.style.position = 'relative';
            section.appendChild(blocksContainer);
        }
        blocksContainer.innerHTML = '';
        const range = 24; // 24 hours
        
        // Filter events by section
        const sectionEvents = allEvents.filter(event => event.section === sectionId);
        
        // Sort events by start time and then by end time for more predictable layout
        sectionEvents.sort((a, b) => {
            if (a.start !== b.start) return a.start - b.start;
            return a.end - b.end;
        });
        
        // Track row assignments for overlapping events
        const rows = [];
        let maxRow = 0;
        
        // Function to check if an event overlaps with events in a specific row
        function eventOverlapsRow(event, rowEvents) {
            for (let existingEvent of rowEvents) {
                // Check for any overlap
                if (!(event.end <= existingEvent.start || event.start >= existingEvent.end)) {
                    return true;
                }
            }
            return false;
        }
        
        // Assign each event to a row
        sectionEvents.forEach(event => {
            if (event.end > event.start) {
                // Find the first row where this event doesn't overlap
                let rowIndex = 0;
                while (rows[rowIndex] && eventOverlapsRow(event, rows[rowIndex])) {
                    rowIndex++;
                }
                
                // Create the row array if it doesn't exist
                if (!rows[rowIndex]) {
                    rows[rowIndex] = [];
                }
                
                // Add event to the row
                rows[rowIndex].push(event);
                
                // Update max row for container height
                maxRow = Math.max(maxRow, rowIndex);
                
                // Create the event block
                const block = document.createElement('button');
                block.className = 'event-block';
                block.textContent = event.name;
                block.dataset.eventId = event.id;
                
                // Apply custom color if available
                if (event.color) {
                    block.style.borderLeftColor = event.color;
                    
                    // Add subtle background tint based on the color
                    const bgColor = event.color + '10'; // Add 10% opacity
                    block.style.background = `linear-gradient(to right, ${bgColor} 0%, #f8fffa 100%)`;
                }
                
                // Calculate left and width as percent of 24 hours
                const left = (event.start / range) * 100;
                const width = ((event.end - event.start) / range) * 100;
                
                // Calculate top position based on row assignment
                const rowHeight = 50; // Height of each row in pixels
                const topPosition = rowIndex * rowHeight; // Position based on row
                
                block.style.position = 'absolute';
                block.style.left = left + '%';
                block.style.width = width + '%';
                block.style.top = topPosition + 'px';
                block.style.height = (rowHeight - 2) + 'px'; // Slight gap between rows
                
                // Add click event to show popup
                block.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event from bubbling up
                    const eventId = parseInt(this.dataset.eventId);
                    const clickedEvent = allEvents.find(evt => evt.id === eventId);
                    
                    if (clickedEvent) {
                        // Show popup at click position
                        showEventPopup(clickedEvent, e.clientX, e.clientY);
                    }
                });
                
                // Add double-click to edit
                block.addEventListener('dblclick', function() {
                    openEditEventForm(event.id);
                });
                
                blocksContainer.appendChild(block);
            }
        });
        
        // Calculate the exact height needed based on rows (each row is 50px high)
        const eventsHeight = (maxRow + 1) * 50; // Height of all events rows
          // Set the events container height (keeps event sizes the same)
        blocksContainer.style.height = Math.max(50, eventsHeight) + 'px';
        
        // Get the title height
        const sectionTitle = section.querySelector('.section-title');
        const titleHeight = sectionTitle ? sectionTitle.offsetHeight + 16 : 0; // Height + margin
        
        // Set explicit height for the main container with a minimum height
        const totalContainerHeight = Math.max(100, titleHeight + eventsHeight + 20); // Minimum 100px
        section.style.height = totalContainerHeight + 'px';
        section.style.minHeight = '100px';
        section.style.paddingBottom = '20px';
        
        // Ensure the countdown is positioned correctly
        const countdownContainer = section.querySelector('.countdown-container');
        if (countdownContainer) {
            countdownContainer.style.top = '16px'; // Adjust as needed
        }
    }

    // Function to render the events list in the edit panel
    function renderEventsList() {
        const eventsList = document.getElementById('eventsList');
        if (eventsList) {
            eventsList.innerHTML = '';
            
            if (allEvents.length === 0) {
                const noEvents = document.createElement('div');
                noEvents.textContent = 'No events found';
                noEvents.style.padding = '10px 0';
                noEvents.style.color = '#777';
                eventsList.appendChild(noEvents);
                return;
            }
            
            allEvents.forEach(event => {
                const eventItem = document.createElement('div');                eventItem.className = 'event-list-item';
                eventItem.style.padding = '8px';
                eventItem.style.margin = '4px 0';
                eventItem.style.borderRadius = '4px';
                eventItem.style.background = '#f7f8fa';
                eventItem.style.cursor = 'pointer';
                eventItem.style.fontSize = '0.9rem';
                
                // Apply custom color if available
                if (event.color) {
                    eventItem.style.borderLeftColor = event.color;
                    eventItem.style.borderLeftWidth = '3px';
                    
                    // Add subtle background tint based on the color
                    const bgColor = event.color + '10'; // Add 10% opacity
                    eventItem.style.background = `linear-gradient(to right, ${bgColor} 0%, #f7f8fa 100%)`;
                }// Format times to display as GMT
                const formatGMTTime = (hour, minute) => {
                    return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                };
                
                eventItem.innerHTML = `
                    <div style="font-weight: 500;">${event.name}</div>
                    <div style="font-size: 0.8rem; color: #666;">
                        ${formatGMTTime(event.startHour, event.startMinute)} - ${formatGMTTime(event.endHour, event.endMinute)} GMT (Section: ${event.section})
                    </div>
                `;
                
                eventItem.addEventListener('click', function() {
                    openEditEventForm(event.id);
                });
                
                eventsList.appendChild(eventItem);
            });
        }    }
    
    // Initialize with a default event if none exist
    if (allEvents.length === 0) {
        // Create multiple events with some overlaps to demonstrate the feature
        createTestEventsWithOverlaps();
    }

    // Make sure event blocks containers are created for both sections
    function ensureEventBlocksContainers() {
        const sections = ['section1', 'section2', 'section3'];
        
        sections.forEach(sectionId => {
            const section = document.getElementById(sectionId + '-container');
            if (!section) return;
            
            let blocksContainer = section.querySelector('.event-blocks');
            if (!blocksContainer) {
                blocksContainer = document.createElement('div');
                blocksContainer.className = 'event-blocks';
                blocksContainer.style.position = 'relative';
                blocksContainer.style.minHeight = '50px';
                section.appendChild(blocksContainer);
            }
        });
    }

    // Call this on initialization
    ensureEventBlocksContainers();

    // Timeline tracer logic with real GMT time
    let timelineInterval = null;
    let isRealTime = true; // Default to real-time mode
    let timelineStart = null;
    let timelineCurrent = null;
    const timelineDuration = 24 * 60 * 60 * 1000; // 24 hours in ms
    
    function getCurrentTimePercent() {
        const date = new Date();
        const hours = date.getUTCHours();
        const minutes = date.getUTCMinutes();
        const seconds = date.getUTCSeconds();
        
        // Calculate the percentage through the day (0-100) based on GMT/UTC time
        const secondsSinceMidnight = hours * 3600 + minutes * 60 + seconds;
        const percentOfDay = (secondsSinceMidnight / 86400) * 100;
        
        return percentOfDay;
    }    function updateTimelineCursor(percent) {
        const hashOuter = document.querySelector('.timeline-hashmarks-outer');
        const cursor = document.getElementById('timeline-cursor');
        if (!hashOuter || !cursor) return;
        
        // Clamp percent between 0 and 100
        const clampedPercent = Math.max(0, Math.min(percent, 100));
        
        // Calculate the exact position to align with the hashline
        const trackerWidth = document.querySelector('.timeline-hashmarks-track').offsetWidth;
        const cursorWidth = cursor.offsetWidth;
        
        // Position cursor relative to the track width, adjusting for the cursor's width
        const pixelPosition = (trackerWidth * clampedPercent / 100);
        cursor.style.left = `${pixelPosition - (cursorWidth / 2)}px`;
          // Calculate total height needed based on all sections
        const section1 = document.getElementById('section1-container');
        const section2 = document.getElementById('section2-container');
        const section3 = document.getElementById('section3-container');
        
        const section1Height = section1 ? section1.offsetHeight : 0;
        const section2Height = section2 ? section2.offsetHeight : 0;
        const section3Height = section3 ? section3.offsetHeight : 0;
        const heightBetweenSections = 30; // Matches the margin-top of section2/section3
        
        // Calculate the total height needed for the cursor
        const cursorHeight = section1Height + section2Height + section3Height + (heightBetweenSections * 2) + 40; // Added extra for visibility
        
        // Set the height with a minimum value
        cursor.style.height = `${Math.max(80, cursorHeight)}px`; 
        cursor.style.display = 'block';
            // Update current time display if in real-time mode
        if (isRealTime) {
            updateCurrentTimeDisplay();
        }
    }
    
    function updateCurrentTimeDisplay() {
        let timePanel = document.getElementById('time-panel');
        if (!timePanel) {
            // Create time panel if it doesn't exist
            timePanel = document.createElement('div');
            timePanel.id = 'time-panel';
            timePanel.className = 'time-panel';
            
            // Create GMT date display
            const gmtDateDisplay = document.createElement('div');
            gmtDateDisplay.id = 'gmt-date-display';
            gmtDateDisplay.className = 'time-panel-item';
            timePanel.appendChild(gmtDateDisplay);
            
            // Create GMT time display
            const gmtDisplay = document.createElement('div');
            gmtDisplay.id = 'gmt-time-display';
            gmtDisplay.className = 'time-panel-item';
            timePanel.appendChild(gmtDisplay);
            
            // Create local time display
            const localDisplay = document.createElement('div');
            localDisplay.id = 'local-time-display';
            localDisplay.className = 'time-panel-item';
            timePanel.appendChild(localDisplay);
              // Add to the timeline - make sure we append it to the body where it will be visible
            const timelineContainer = document.querySelector('.timeline-bar.timeline-hashmarks');
            if (timelineContainer) {
                timelineContainer.appendChild(timePanel);
            } else {
                // Fallback if the timeline container isn't found
                document.body.appendChild(timePanel);
            }
        }
        
        const date = new Date();
        
        // Format the date for GMT display
        const utcDateOptions = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            timeZone: 'UTC'
        };
        
        // Format the current time with UTC/GMT indicator
        const utcOptions = {
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            timeZone: 'UTC',
            hour12: false
        };
        
        const localOptions = {
            hour: '2-digit', 
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        
        const utcDate = date.toLocaleDateString('en-US', utcDateOptions);
        const utcTime = date.toLocaleTimeString('en-US', utcOptions);
        const localTime = date.toLocaleTimeString('en-US', localOptions);
        
        // Update the GMT date display
        const gmtDateDisplay = document.getElementById('gmt-date-display');
        gmtDateDisplay.innerHTML = `<span class="time-panel-label">GMT Date:</span> ${utcDate}`;
          // Update the GMT time display
        const gmtDisplay = document.getElementById('gmt-time-display');
        gmtDisplay.innerHTML = `<span class="time-panel-label">GMT Time:</span> ${utcTime}`;
        
        // Update the local time display
        const localDisplay = document.getElementById('local-time-display');
        localDisplay.innerHTML = `<span class="time-panel-label">Local Time:</span> ${localTime}`;
    }
    
    function startTimeline() {
        if (timelineInterval) clearInterval(timelineInterval);
        
        // Get the cursor and highlight it when running
        const cursor = document.getElementById('timeline-cursor');
        if (cursor) {
            cursor.classList.add('active');
            cursor.style.opacity = '0.85';
        }
        
        // Switch to real-time mode using GMT/UTC
        isRealTime = true;
        
        // Start updating the cursor based on current time
        moveCursor();
        timelineInterval = setInterval(moveCursor, 1000); // Update every second for real-time
        
        // Update mode indicator if it exists
        const modeIndicator = document.getElementById('modeIndicator');
        if (modeIndicator) {tgyfdr
            modeIndicator.textContent = 'Real-Time Mode (GMT)';
        }
    }
      function startAnimation() {
        if (timelineInterval) clearInterval(timelineInterval);
        
        // Get the cursor and highlight it when running
        const cursor = document.getElementById('timeline-cursor');
        if (cursor) {
            cursor.classList.add('active');
            cursor.style.opacity = '0.85';
        }
        
        // Switch to animation mode
        isRealTime = false;
        
        // Start the animation
        timelineStart = Date.now();
        timelineCurrent = timelineStart;
        moveCursor();
        timelineInterval = setInterval(moveCursor, 50); // Faster updates for animation
        
        // Update mode indicator if it exists
        const modeIndicator = document.getElementById('modeIndicator');
        if (modeIndicator) {
            modeIndicator.textContent = 'Animation Mode';
        }
    }

    function stopTimeline() {
        if (timelineInterval) clearInterval(timelineInterval);
        
        // Dim the cursor when stopped
        const cursor = document.getElementById('timeline-cursor');
        if (cursor) {
            cursor.classList.remove('active');
        }
        
        // Update mode indicator if it exists
        const modeIndicator = document.getElementById('modeIndicator');        if (modeIndicator) {
            modeIndicator.textContent = 'Paused';
        }
    }
    
    function resetTimeline() {
        stopTimeline();
        
        // Make sure cursor is visible at start position
        const cursor = document.getElementById('timeline-cursor');
        if (cursor) {
            cursor.classList.remove('active');
            cursor.style.opacity = '0.7';
            cursor.style.display = 'block';
        }
        
        updateTimelineCursor(0); // Reset to hour 0 (far left of hashline)
        
        // Update mode indicator if it exists
        const modeIndicator = document.getElementById('modeIndicator');
        if (modeIndicator) {
            modeIndicator.textContent = 'Reset';        }
    }
    
    function moveCursor() {
        if (isRealTime) {
            // Real-time mode - use current GMT/UTC time
            const percent = getCurrentTimePercent();
            requestAnimationFrame(() => {
                updateTimelineCursor(percent);
            });
        } else {
            // Animation mode - use elapsed time
            timelineCurrent = Date.now();
            let elapsed = timelineCurrent - timelineStart;
            if (elapsed > timelineDuration) elapsed = timelineDuration;
            const percent = (elapsed / timelineDuration) * 100;
            
            // Use requestAnimationFrame for smoother animation
            if (percent % 0.2 < 0.1) { // Throttle updates slightly for better performance
                requestAnimationFrame(() => {
                    updateTimelineCursor(percent);
                });
            }
              if (elapsed >= timelineDuration) stopTimeline();
        }
    }
      document.getElementById('startTimeline').onclick = startTimeline;
    document.getElementById('startAnimation').onclick = startAnimation;
    document.getElementById('stopTimeline').onclick = stopTimeline;
    document.getElementById('resetTimeline').onclick = resetTimeline;
    document.getElementById('logisticsMenuBtn').onclick = toggleMenu;
    document.getElementById('menuBackdrop').onclick = toggleMenu;
    
    function toggleMenu() {
        const controls = document.getElementById('timelineControls');
        const backdrop = document.getElementById('menuBackdrop');
        const isHidden = controls.style.display === 'none';
        
        controls.style.display = isHidden ? 'flex' : 'none';
        backdrop.style.display = isHidden ? 'block' : 'none';
        
        // Reset any open form sections when closing
        if (!isHidden) {
            showSection(null);
        }    };
    
    // Make sure cursor and events are initialized properly when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Render the hashline
        renderStaticHashmarks();
        
        // Ensure event blocks containers exist for both sections
        ensureEventBlocksContainers();
        
        // Load saved events from local storage
        loadEvents();
        
        // Initialize the next event countdown
        updateNextEventCountdown();
        
        // Start in real-time mode by default after a short delay
        setTimeout(function() {
            startTimeline();
            
            // Force container sizing update after timeline starts
            // This ensures everything is fully rendered before measuring
            setTimeout(renderAndPlaceEvents, 100);
        }, 500);
    });
    
    // Event Form Management Functions
    function showSection(sectionId) {
        // Hide all sections
        document.getElementById('eventFormSection').style.display = 'none';
        document.getElementById('eventListSection').style.display = 'none';
        document.getElementById('editEventSection').style.display = 'none';
        
        // Show the requested section
        if (sectionId) {
            document.getElementById(sectionId).style.display = 'block';
        }
    }
    
    function openCreateEventForm() {
        // Reset the form
        document.getElementById('eventName').value = '';
        document.getElementById('eventStartHour').value = '';
        document.getElementById('eventStartMinute').value = '';
        document.getElementById('eventEndHour').value = '';
        document.getElementById('eventEndMinute').value = '';
        document.getElementById('eventColor').value = '#2ecc40'; // Default green
        
        // Show the form
        showSection('eventFormSection');
    }

    function openManageEvents() {
        renderEventsList();
        showSection('eventListSection');
    }
    
    function openEditEventForm(eventId) {
        const event = allEvents.find(evt => evt.id === Number(eventId));
        if (!event) return;
        
        // Populate form fields
        document.getElementById('editEventId').value = event.id;
        document.getElementById('editEventName').value = event.name;
        document.getElementById('editEventStartHour').value = event.startHour;
        document.getElementById('editEventStartMinute').value = event.startMinute;        
        document.getElementById('editEventEndHour').value = event.endHour;
        document.getElementById('editEventEndMinute').value = event.endMinute;
        
        // Set section if available
        if (document.getElementById('editEventSection')) {
            document.getElementById('editEventSection').value = event.section || 'section1';
        }
        
        // Set color if available
        if (event.color) {
            document.getElementById('editEventColor').value = event.color;
        } else {
            document.getElementById('editEventColor').value = '#2ecc40'; // Default green
        }
          // Show the edit form
        showSection('editEventSection');
    }
    
    function handleSaveEvent() {
        const name = document.getElementById('eventName').value;
        const startHour = parseInt(document.getElementById('eventStartHour').value);
        const startMinute = parseInt(document.getElementById('eventStartMinute').value);
        const endHour = parseInt(document.getElementById('eventEndHour').value);
        const endMinute = parseInt(document.getElementById('eventEndMinute').value);
        const section = document.getElementById('eventSection').value;
        
        // Simple validation
        if (!name || isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) {
            alert('Please enter valid event details.');
            return;
        }
        
        // Convert to decimal hours for comparison
        const startDecimal = startHour + (startMinute / 60);
        const endDecimal = endHour + (endMinute / 60);
        
        if (endDecimal <= startDecimal) {
            alert('End time must be greater than start time.');
            return;
        }
          // Validate GMT times
        if (startHour < 0 || startHour > 23 || endHour < 0 || endHour > 23 ||
            startMinute < 0 || startMinute > 59 || endMinute < 0 || endMinute > 59) {
            alert('Hours must be between 0-23 and minutes between 0-59.');
            return;
        }
        
        // Get selected color
        const color = document.getElementById('eventColor').value;
        
        // Create the event
        createEvent(name, startHour, startMinute, endHour, endMinute, section, color);
          // Close the form
        showSection(null);
    }
    
    function handleUpdateEvent() {
        const id = Number(document.getElementById('editEventId').value);
        const name = document.getElementById('editEventName').value;
        const startHour = parseInt(document.getElementById('editEventStartHour').value);
        const startMinute = parseInt(document.getElementById('editEventStartMinute').value);
        const endHour = parseInt(document.getElementById('editEventEndHour').value);
        const endMinute = parseInt(document.getElementById('editEventEndMinute').value);
        
        // Simple validation
        if (!name || isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) {
            alert('Please enter valid event details.');
            return;
        }
        
        // Convert to decimal hours for comparison
        const startDecimal = startHour + (startMinute / 60);
        const endDecimal = endHour + (endMinute / 60);
        
        if (endDecimal <= startDecimal) {
            alert('End time must be greater than start time.');
            return;
        }
          // Validate GMT times
        if (startHour < 0 || startHour > 23 || endHour < 0 || endHour > 23 ||
            startMinute < 0 || startMinute > 59 || endMinute < 0 || endMinute > 59) {
            alert('Hours must be between 0-23 and minutes between 0-59.');
            return;
        }
        
        // Get selected color
        const color = document.getElementById('editEventColor').value;
        
        // Get section if available
        let section;
        const sectionSelect = document.getElementById('editEventSection');
        if (sectionSelect) {
            section = sectionSelect.value;
        }
        
        // Update the event
        if (updateEvent(id, { 
            name, 
            startHour, 
            startMinute, 
            endHour, 
            endMinute, 
            color,
            section 
        })) {
            // Close the form
            showSection(null);
        }
    }

    function handleDeleteEvent() {
        const id = Number(document.getElementById('editEventId').value);
        if (confirm('Are you sure you want to delete this event?')) {
            if (deleteEvent(id)) {
                // Close the form
                showSection(null);
            }        }
    }
    
    document.getElementById('createEventBtn').onclick = openCreateEventForm;
    document.getElementById('manageEventsBtn').onclick = openManageEvents;
    document.getElementById('saveEventBtn').onclick = handleSaveEvent;
    document.getElementById('updateEventBtn').onclick = handleUpdateEvent;
    document.getElementById('deleteEventBtn').onclick = handleDeleteEvent;
    document.getElementById('backToEventsBtn').onclick = function() {
        showSection('eventListSection');
    };
    document.getElementById('cancelEventBtn').onclick = function() {
        showSection(null);
    };
    document.getElementById('cancelEditBtn').onclick = function() {
        showSection(null);    };
    
    // Function to update the countdown to the next event
    function updateNextEventCountdown() {
        // Update countdown for section 1
        updateSectionCountdown('next-event-countdown', 'section1');
        
        // Update countdown for section 2
        updateSectionCountdown('section2-next-event-countdown', 'section2');
        
        // Update countdown for section 3
        updateSectionCountdown('section3-next-event-countdown', 'section3');
    }
    
    // Function to update countdown for a specific section
    function updateSectionCountdown(elementId, sectionId) {
        const countdownElement = document.getElementById(elementId);
        if (!countdownElement) return;
        
        // Get current GMT time
        const now = new Date();
        const currentGMTHours = now.getUTCHours();
        const currentGMTMinutes = now.getUTCMinutes();
        const currentGMTSeconds = now.getUTCSeconds();
        
        // Convert current time to decimal hours for comparison
        const currentTimeDecimal = currentGMTHours + (currentGMTMinutes / 60) + (currentGMTSeconds / 3600);
        
        // Find the next upcoming event in this section
        let nextEvent = null;        let minTimeDifference = Infinity;
        
        // Filter events by section
        const sectionEvents = allEvents.filter(event => event.section === sectionId);
        
        sectionEvents.forEach(event => {
            const eventStartDecimal = event.startHour + (event.startMinute / 60);
            
            // Calculate time difference (handling day wraparound)
            let timeDiff = eventStartDecimal - currentTimeDecimal;
            if (timeDiff < 0) timeDiff += 24; // Event is tomorrow
            
            if (timeDiff > 0 && timeDiff < minTimeDifference) {
                minTimeDifference = timeDiff;
                nextEvent = event;
            }
        });
          // Find the countdown label element that's a sibling of the countdown timer
        const countdownContainer = countdownElement.parentElement;
        const countdownLabel = countdownContainer ? countdownContainer.querySelector('.countdown-label') : null;
        
        if (!nextEvent) {
            countdownElement.textContent = "No upcoming events";
            if (countdownLabel) {
                countdownLabel.textContent = "Next Event:";
            }
            return;
        }
        
        // Calculate hours, minutes, seconds until next event
        const totalSeconds = Math.floor(minTimeDifference * 3600);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        // Format as HH:MM:SS
        const formattedTime = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        countdownElement.textContent = formattedTime;
          // Update the countdown label with the next event name
        if (countdownLabel) {
            countdownLabel.innerHTML = `<span style="color: #000;">${nextEvent.name}</span> begins in:`;
        }
    }
    
    // Update the countdown every second
    setInterval(updateNextEventCountdown, 1000);
    
    // Update countdown when events change
    function updateCountdownOnEventChange() {
        // This function combines saving events and updating the countdown
        saveEvents();
        renderAndPlaceEvents();
        updateNextEventCountdown();
    }
    
    // Event popup handling
    let currentPopupTimeout = null;
    
    function showEventPopup(event, clickX, clickY) {
        // Clear any existing popup timeout
        if (currentPopupTimeout) {
            clearTimeout(currentPopupTimeout);
        }
        
        const popup = document.getElementById('event-popup');
        if (!popup) return;
        
        // Format the times nicely
        const formatTime = (hour, minute) => {
            return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')} GMT`;
        };
          // Set popup content
        popup.innerHTML = `
            <div class="event-popup-name" style="color: ${event.color || '#2ecc40'};">${event.name}</div>
            <div class="event-popup-time">Start: ${formatTime(event.startHour, event.startMinute)}</div>
            <div class="event-popup-time">End: ${formatTime(event.endHour, event.endMinute)}</div>
            ${event.color ? `<div class="event-popup-time" style="display: flex; align-items: center; gap: 5px;">
                <span>Color:</span> 
                <span style="display: inline-block; width: 14px; height: 14px; background-color: ${event.color}; border-radius: 2px;"></span>
            </div>` : ''}
        `;
        
        // Position the popup near the click, but ensure it stays in viewport
        const popupWidth = 220; // Approximate width
        const popupHeight = 100; // Approximate height
        
        // Calculate position to ensure popup stays in viewport
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Default positions
        let left = clickX + 10;
        let top = clickY - 10;
        
        // Adjust if would go offscreen
        if (left + popupWidth > viewportWidth - 20) {
            left = clickX - popupWidth - 10;
        }
        
        if (top + popupHeight > viewportHeight - 20) {
            top = clickY - popupHeight - 10;
        }
        
        // Position and show popup
        popup.style.left = `${left}px`;
        popup.style.top = `${top}px`;
        popup.style.display = 'block';
        
        // Hide popup after 3 seconds
        currentPopupTimeout = setTimeout(() => {
            popup.style.display = 'none';
        }, 3000);
    }
    
    // Add click handler to document to hide popup when clicking elsewhere
    document.addEventListener('click', function(e) {
        // If the click wasn't on an event block, hide the popup
        if (!e.target.closest('.event-block')) {
            const popup = document.getElementById('event-popup');
            if (popup) {
                popup.style.display = 'none';
            }
            if (currentPopupTimeout) {
                clearTimeout(currentPopupTimeout);
            }
        }
    });
    
    // Handle color preset buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('color-box')) {
            const color = e.target.getAttribute('data-color');
            
            // Find the closest color input field
            const eventForm = e.target.closest('#eventFormSection');
            const editForm = e.target.closest('#editEventSection');
            
            if (eventForm) {
                document.getElementById('eventColor').value = color;
            } else if (editForm) {
                document.getElementById('editEventColor').value = color;
            }
        }
    });
      // Function to create test events with overlaps (for development purposes)
    function createTestEventsWithOverlaps() {
        // Clear existing events
        allEvents = [];
        currentEventId = 0;
        
        // Create events for section 1 with various overlaps8
        createEvent('TBD', 0, 0, 4, 0, 'section1', '#2ecc40');
        createEvent('Lunar Flyby', 4, 0, 10, 0, 'section1', '#3498db');
        createEvent('TBD', 10, 0, 14, 0, 'section1', '#2ecc40');
        createEvent('Crew Sleep', 14, 0, 22, 0, 'section1', '#9b59b6');
        createEvent('Downlink', 16, 0, 17, 30, 'section1', '#2ecc40');
          // Create events for section 2
        createEvent('Flyby Documentation', 0, 0, 14, 0, 'section2', '#e74c3c');
        createEvent('Kickoff Meeting', 0, 5, 2, 0, 'section2', '#3498db');
        createEvent('Deployment', 12, 0, 14, 0, 'section2', '#3498db');
        createEvent('Downlink I', 19, 0, 23, 0, 'section2', '#9b59b6');
        createEvent('Handover', 19, 30, 21, 30, 'section2', '#3498db');
        
        // Create events for section 3
        createEvent('Downlink I', 16, 0, 22, 0, 'section3', '#2ecc40');
        createEvent('Kickoff Meeting', 16, 5, 18, 0, 'section3', '#3498db');
        createEvent('Handover', 19, 30, 21, 30, 'section3', '#3498db');
        
        updateNextEventCountdown();
    }
    </script>
</body>
</html>